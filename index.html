<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembuat Stiker Label Aset Sekolah (Batch)</title>
    <!-- Memuat Tailwind CSS untuk desain responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat qrcode.js untuk membuat Kode QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Memuat SheetJS/XLSX untuk membaca dan menulis file Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* Gaya kustom untuk memastikan label terlihat profesional dan kecil */
        .sticker-label {
            /* Ukuran label yang ideal untuk stiker (sekitar 7.6cm) */
            width: 300px; 
            height: auto;
            border: 1px solid #9ca3af; /* Border lebih tipis untuk batch */
            padding: 8px;
            margin: 10px; /* Jarak antar stiker */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            page-break-inside: avoid; /* Penting untuk pencetakan, agar stiker tidak terpotong */
            flex-shrink: 0; /* Pastikan stiker tidak menyusut */
        }

        /* Kontainer untuk label yang dihasilkan */
        #batch-container {
            display: flex;
            flex-wrap: wrap; /* Memastikan label menyesuaikan diri dalam baris */
            /* Menggunakan justify-center hanya untuk tampilan layar */
            justify-content: center; 
            align-items: flex-start;
        }

        /* --- PERBAIKAN CSS CETAK --- */
        @media print {
            body {
                background-color: white !important;
                margin: 0;
                padding: 0;
            }
            
            /* Sembunyikan Header */
            header {
                display: none !important;
            }

            /* Sembunyikan Panel Input (ID baru: #input-panel) */
            #input-panel {
                display: none !important;
            }
            
            /* Sembunyikan elemen di dalam Panel Output yang tidak diperlukan saat cetak */
            #output-panel h2, 
            #output-panel #message, 
            #output-panel #print-button {
                display: none !important;
            }
            
            /* Kontainer flex utama (yang berisi panel input dan output) diatur ulang agar tampil penuh */
            .flex.flex-col.lg\:flex-row {
                display: block !important;
                width: 100%;
            }

            /* Hapus batasan lebar pada kontainer paling luar */
            .max-w-6xl {
                max-width: none !important;
                margin: 0 !important;
            }

            /* Atur ulang batch-container agar memenuhi halaman cetak */
            #batch-container {
                width: 100% !important;
                margin: 0;
                /* PENTING: Menggunakan padding minimal dan gap agar dua stiker muat */
                padding: 5px 0; 
                gap: 5px; /* Jarak antar stiker */
                
                /* Kunci utama: Tampilkan kembali sebagai flex container */
                display: flex !important;
                flex-wrap: wrap !important;
                /* Gunakan space-evenly untuk mendistribusikan dua stiker di satu baris */
                justify-content: space-evenly !important; 
                align-items: flex-start;
                box-shadow: none;
                background-color: white !important;
                min-height: auto !important;
            }
            
            .sticker-label {
                border: 1px dashed #6b7280; 
                /* Margin diperkecil agar dua stiker muat di kertas A4 */
                margin: 2px; 
                box-shadow: none;
                /* Lebar 300px + 2px margin kiri + 2px margin kanan = 304px. 
                   Ini akan memaksa dua stiker per baris di kertas A4 */
                width: 300px; 
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">Pembuat Stiker Aset (Batch)</h1>
            <p class="text-gray-600 mt-2">Masukkan data aset dalam format CSV atau impor file XLSX/CSV.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Panel Input Kontrol (Ditambahkan ID untuk penyembunyian saat cetak) -->
            <div id="input-panel" class="lg:w-1/2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">Masukkan Data Aset</h2>
                
                <p class="text-sm text-red-600 mb-2 font-medium">
                    Format wajib (Kolom A-E): Nama Sekolah,Nama Aset,Kode Inventaris,Tanggal Akuisisi (YYYY-MM-DD),**Jenis Aset**
                </p>
                
                <!-- Kontrol Impor/Template Diperbarui -->
                <div class="flex justify-between items-center mb-4">
                    <button type="button" onclick="downloadExcelTemplate()"
                        class="bg-gray-300 text-gray-800 py-1.5 px-4 rounded-lg text-sm font-semibold hover:bg-gray-400 transition duration-150">
                        Download Template (XLSX)
                    </button>
                    <label for="csv-file" class="cursor-pointer bg-blue-100 text-blue-700 py-1.5 px-4 rounded-lg text-sm font-semibold hover:bg-blue-200 transition duration-150">
                        Import File XLSX/CSV
                    </label>
                    <!-- Menerima file XLSX dan CSV -->
                    <input type="file" id="csv-file" accept=".csv, .txt, .xlsx, .xls" class="hidden" onchange="handleFileUpload(event)">
                </div>
                <!-- Akhir Kontrol Impor/Template Diperbarui -->

                <form id="asset-form" onsubmit="event.preventDefault(); generateBatchLabels();">
                    
                    <div class="mb-6">
                        <textarea id="csv-input" rows="10" placeholder="Tempelkan data CSV di sini, atau impor file XLSX." required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm font-mono text-xs">UPT SD NEGERI 067953,Laptop Lenovo Dapodik,INV/SDN-953/EL/2025/001,2025-09-01,BOS 2025
SMAN 1 JAYA SENTOSA,Proyektor Aula,INV/SMAN1/PR/2024/002,2023-11-15,ASET Dinas 2024
SMPN 5 KOTA,Lemari Arsip Ruang TU,INV/SMP5/LM/2024/003,2024-03-20,BOS 2024
SMKN 3 TEKNIK,Mesin Cetak 3D,INV/SMK3/MC/2025/004,2025-01-10,Hibah</textarea>
                    </div>

                    <button type="submit"
                            class="w-full bg-blue-600 text-white py-2 px-4 border border-transparent rounded-lg shadow-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Buat & Tampilkan Label
                    </button>
                </form>
            </div>

            <!-- Panel Pratinjau Stiker (Ditambahkan ID untuk kontrol saat cetak) -->
            <div id="output-panel" class="lg:w-1/2 bg-white p-6 rounded-xl shadow-lg flex flex-col items-center">
                <h2 class="text-2xl font-semibold mb-4 text-blue-700">Pratinjau Label Batch</h2>
                
                <div id="batch-container" class="bg-gray-100 p-2 rounded-lg w-full min-h-64">
                    <!-- Semua label akan dimasukkan di sini oleh JavaScript -->
                </div>

                <div id="message" class="mt-4 text-gray-500">
                    Silakan klik "Buat & Tampilkan Label" atau Impor File XLSX/CSV untuk melihat hasilnya.
                </div>

                <button id="print-button" onclick="window.print()" disabled
                        class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Cetak Semua Label
                </button>
            </div>
        </div>

    </div>

    <script>
        // Instance QRCodeJS tidak perlu disimpan secara global karena dibuat per label

        /**
         * Fungsi untuk mengunduh template XLSX (Excel).
         */
        function downloadExcelTemplate() {
            // Data untuk template (termasuk header, sekarang 5 kolom)
            const templateData = [
                ["Nama Sekolah", "Nama Aset", "Kode Inventaris", "Tanggal Akuisisi (YYYY-MM-DD)", "Jenis Aset"],
                ["SMAN 1 JAYA SENTOSA", "Laptop Acer Ruang 1", "INV/SMAN1/LT/2024/001", "2024-01-01", "BOS 2024"],
                ["SMPN 5 KOTA", "Meja Guru Kimia", "INV/SMP5/MG/2024/003", "2024-03-20", "ASET Dinas 2023"]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Aset");
            
            // Tulis dan unduh file XLSX
            XLSX.writeFile(wb, "template_aset_sekolah.xlsx");
        }

        /**
         * Fungsi untuk menangani unggahan file, membaca isinya, dan mengisi textarea.
         * Sekarang mendukung XLSX/XLS dan CSV/TXT.
         * @param {Event} event - Event unggahan file.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const messageElement = document.getElementById('message');
            const printButton = document.getElementById('print-button');

            if (!file) {
                messageElement.textContent = "Tidak ada file yang dipilih.";
                printButton.disabled = true;
                return;
            }
            
            // Set pesan loading
            messageElement.textContent = `Membaca file ${file.name}...`;

            const reader = new FileReader();

            reader.onload = function(e) {
                let fileContent = '';
                const extension = file.name.split('.').pop().toLowerCase();
                
                try {
                    if (extension === 'xlsx' || extension === 'xls') {
                        // --- Logika Impor XLSX ---
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Konversi sheet menjadi CSV string, lalu hapus baris header (baris 1)
                        let csvString = XLSX.utils.sheet_to_csv(worksheet, { header: 1 });
                        
                        // Pisahkan menjadi baris, hapus baris pertama (header), dan gabungkan kembali
                        const lines = csvString.trim().split('\n');
                        if (lines.length > 0) {
                            // Abaikan baris pertama (Header) saat mengimpor dari Excel template
                            fileContent = lines.slice(1).join('\n'); 
                        }

                    } else if (extension === 'csv' || extension === 'txt') {
                        // --- Logika Impor CSV/TXT (text-based) ---
                        fileContent = e.target.result;
                        
                    } else {
                         throw new Error("Format file tidak didukung.");
                    }

                    // Isi textarea dengan konten yang sudah diproses
                    document.getElementById('csv-input').value = fileContent.trim();
                    // Setelah mengisi textarea, otomatis buat label
                    generateBatchLabels();

                } catch (error) {
                    messageElement.textContent = `Gagal memproses file: ${error.message}`;
                    printButton.disabled = true;
                } finally {
                    // Bersihkan input file agar file yang sama bisa diupload ulang
                    event.target.value = ''; 
                }
            };

            reader.onerror = function() {
                messageElement.textContent = 'Gagal membaca file. Pastikan format file benar.';
                printButton.disabled = true;
                event.target.value = '';
            };
            
            // Untuk XLSX/XLS, kita harus membaca sebagai ArrayBuffer
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }


        /**
         * Mengambil data dari form CSV, memproses, dan menghasilkan semua label.
         */
        function generateBatchLabels() {
            const csvData = document.getElementById('csv-input').value;
            const container = document.getElementById('batch-container');
            const messageElement = document.getElementById('message');
            const printButton = document.getElementById('print-button');
            
            // Bersihkan kontainer sebelumnya
            container.innerHTML = '';
            
            const lines = csvData.trim().split('\n');
            let generatedCount = 0;

            if (lines.length === 0 || csvData.trim() === '') {
                messageElement.textContent = "Data CSV kosong. Harap masukkan data aset.";
                printButton.disabled = true;
                return;
            }

            // Loop melalui setiap baris data
            lines.forEach((line, index) => {
                const lineTrimmed = line.trim();
                if (lineTrimmed === '') return;

                // Pisahkan kolom menggunakan koma (CSV)
                // Catatan: Ini adalah parser CSV yang sangat sederhana.
                const columns = lineTrimmed.split(',').map(col => col.trim());

                // Memastikan minimal 5 kolom ada (Dulu 4)
                if (columns.length < 5) {
                    console.error(`Baris ${index + 1} diabaikan: Format tidak valid. Diperlukan 5 kolom, ditemukan ${columns.length}.`);
                    return; // Lewati baris yang tidak valid
                }

                // Buat ID yang konsisten untuk elemen QR Code berdasarkan indeks
                const qrcodeId = `qrcode-${index}`;
                
                // MENGAMBIL KOLOM KE-5 (INDEX 4) SEBAGAI JENIS ASET
                const data = {
                    schoolName: columns[0],
                    assetName: columns[1],
                    assetCode: columns[2],
                    acquisitionDate: columns[3],
                    assetType: columns[4], // Kolom baru
                    qrcodeId: qrcodeId 
                };
                
                // Hasilkan dan tambahkan HTML untuk label tunggal
                const labelElement = document.createElement('div');
                labelElement.innerHTML = generateSingleLabelHtml(data); 
                container.appendChild(labelElement.firstElementChild); // Ambil div .sticker-label
                
                // Hasilkan QR Code di elemen label yang baru dibuat
                generateQRCode(data.qrcodeId, data);

                generatedCount++;
            });

            // Perbarui status dan tombol cetak
            if (generatedCount > 0) {
                messageElement.textContent = `Berhasil membuat ${generatedCount} label. Siap dicetak.`;
                printButton.disabled = false;
            } else {
                messageElement.textContent = "Tidak ada label yang valid ditemukan dari input CSV.";
                printButton.disabled = true;
            }
        }

        /**
         * Mengembalikan string HTML untuk satu stiker label.
         * @param {Object} data - Objek data aset. Harus menyertakan data.qrcodeId dan data.assetType.
         */
        function generateSingleLabelHtml(data) {
            // Format tanggal agar lebih mudah dibaca
            let formattedDate;
            try {
                const dateObj = new Date(data.acquisitionDate);
                // Cek apakah tanggal valid sebelum format
                if (isNaN(dateObj) || data.acquisitionDate.length < 10) { // Cek format tanggal (YYYY-MM-DD)
                    formattedDate = data.acquisitionDate;
                } else {
                    formattedDate = dateObj.toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                formattedDate = data.acquisitionDate; // Tampilkan mentah jika format gagal
            }

            // Gunakan ID yang sudah disediakan di objek data (data.qrcodeId)
            const qrcodeId = data.qrcodeId;
            
            return `
                <div class="sticker-label bg-white">
                    <div class="text-center border-b pb-1 mb-2 border-gray-400">
                        <p class="font-bold text-xs uppercase text-blue-800">${data.schoolName}</p>
                        <!-- MENAMPILKAN JENIS ASET BARU -->
                        <p class="text-xs text-gray-600 font-medium mt-0.5">${data.assetType}</p>
                    </div>
                    
                    <div class="flex items-start">
                        <div class="flex-grow">
                            <p class="text-xs text-gray-600 font-medium">Aset:</p>
                            <p class="font-extrabold text-sm leading-tight text-gray-900 mb-1">${data.assetName}</p>
                            
                            <p class="text-xs text-gray-600 font-medium">Kode INV:</p>
                            <p class="font-mono text-xs leading-snug text-gray-700 mb-1">${data.assetCode}</p>
                            
                            <p class="text-xs text-gray-600 font-medium">Tgl Akuisisi:</p>
                            <p class="text-xs leading-snug text-gray-700">${formattedDate}</p>
                        </div>

                        <!-- Tambahkan padding (p-1) untuk memastikan ada zona tenang (quiet zone) yang cukup -->
                        <div id="${qrcodeId}" class="ml-4 flex-shrink-0 p-1">
                            <!-- QR Code akan dihasilkan di sini -->
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Menghasilkan Kode QR untuk data aset tertentu.
         * @param {string} targetId - ID elemen div tempat QR akan digambar.
         * @param {Object} data - Objek data aset.
         */
        function generateQRCode(targetId, data) {
            const qrcodeDiv = document.getElementById(targetId);
            
            // Tambahkan console log untuk debugging
            if (!qrcodeDiv) {
                console.error(`Error: Element with ID ${targetId} not found in the DOM.`);
                return;
            }

            // Hapus QR Code lama jika ada
            qrcodeDiv.innerHTML = '';
            
            // Data QR Code (menggunakan format JSON string)
            // Tambahkan jenis aset ke data QR Code
            const qrData = JSON.stringify({
                sekolah: data.schoolName,
                jenis: data.assetType, // Data baru
                nama: data.assetName,
                kode: data.assetCode,
                tgl: data.acquisitionDate
            });

            // Inisialisasi instance qrcode baru
            new QRCode(qrcodeDiv, {
                text: qrData,
                // Ukuran QR diperbesar dari 75 menjadi 85 untuk scanability yang lebih baik
                width: 85, 
                height: 85,
                colorDark : "#000000",
                colorLight : "#ffffff",
                // CorrectLevel H (Highest) sudah digunakan untuk toleransi kesalahan maksimum
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // Jalankan fungsi generateBatchLabels secara otomatis saat halaman dimuat
        window.onload = function() {
            // Panggil fungsi untuk menghasilkan label dari data default
            generateBatchLabels();
        }
    </script>
</body>
</html>
